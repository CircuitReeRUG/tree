This folder houses the code upload/editor + scheduler + runner + queue visualization page.

# The runner
These docs have been generated by Claude. If you don't like 'em, read the source in `runner/`.

## Overview
The runner executes user-submitted Python code in a sandboxed environment using RestrictedPython. It provides a safe execution context with limited builtins and exposes specific functions for controlling the LED tree.

## Architecture

### `main.py` - Code Execution Engine
The main execution module that compiles and runs user code with security restrictions.

#### `execute_code(code: str) -> str`
Executes user-provided Python code in a restricted environment.

**Security Features:**
- Uses RestrictedPython's `compile_restricted()` to prevent dangerous operations
- Limited builtins (no `eval`, `exec`, `open`, `__import__`, etc.)
- Safe attribute access via `safer_getattr`
- Guarded iteration and unpacking
- Print output collected via `PrintCollector`

**Available to User Code:**
- **Standard Library**: `math`, `random` (no other imports allowed)
- **LED Functions**: `getLEDCount()`, `setLEDs()`, `clearLEDs()`
- **Color Constants**: `RED`, `GREEN`, `BLUE`, `YELLOW`, `CYAN`, `MAGENTA`, `WHITE`, `ORANGE`, `PURPLE`, `PINK`, `OFF`

**Returns:**
- Success: Collected print output or "No prints invoked, but your program executed ok"
- Error: Error message prefixed with "Error: "

**Example:**
```python
code = """
led_count = getLEDCount()
states = [RED] * led_count
setLEDs(states)
print("All LEDs set to red!")
"""
output = execute_code(code)  # Returns: "All LEDs set to red!"
```

---

### `color.py` - Predefined Color Constants
Provides convenient color constants for LED control.

#### Color Class
All colors are tuples of `(R, G, B, L)` where:
- **R, G, B**: 0-255 (Red, Green, Blue channels)
- **L**: 0-100 (Brightness level, always 100 for presets)

**Available Colors:**

| Constant | RGB Values | Description |
|----------|-----------|-------------|
| `RED` | (255, 0, 0, 100) | Pure red |
| `GREEN` | (0, 255, 0, 100) | Pure green |
| `BLUE` | (0, 0, 255, 100) | Pure blue |
| `YELLOW` | (255, 255, 0, 100) | Red + Green |
| `CYAN` | (0, 255, 255, 100) | Green + Blue |
| `MAGENTA` | (255, 0, 255, 100) | Red + Blue |
| `WHITE` | (255, 255, 255, 100) | All channels max |
| `ORANGE` | (255, 165, 0, 100) | Orange hue |
| `PURPLE` | (128, 0, 128, 100) | Purple hue |
| `PINK` | (255, 192, 203, 100) | Pink hue |
| `OFF` | (0, 0, 0, 0) | LEDs off (0 brightness) |

**Usage:**
```python
# Simple color application
states = [BLUE] * getLEDCount()
setLEDs(states)

# Mix colors
states = [RED, GREEN, BLUE, YELLOW] * (getLEDCount() // 4)
setLEDs(states)
```

---

### `exposed.py` - LED Control API
Provides the interface between user code and the LED hardware via Unix socket.

#### Configuration
- **`SIZE`**: Number of LEDs (from env var `TREE_LEDS`, default: 1)
- **`SERVER_ADDRESS`**: Unix socket path (from env var `LED_SOCKET_PATH`, default: `/tmp/led_socket`)
- **`leds`**: Global state tracking current LED configuration

---

#### `getLEDCount() -> int`
Returns the number of LEDs in the tree.

**Returns:** Integer count of LEDs

**Example:**
```python
count = getLEDCount()
print(f"Tree has {count} LEDs")
```

---

#### `setLEDs(new_leds: list[tuple[int,int,int,int]]) -> bool`
Sets all LED states simultaneously. This is the primary function for controlling the tree.

**Parameters:**
- `new_leds`: List of tuples, each representing one LED as `(R, G, B, L)`
  - **R, G, B**: 0-255 (color channels)
  - **L**: 0-100 (brightness level)

**Validation:**
- List length must exactly match `SIZE`
- Each element must be a tuple of 4 integers
- All values must be integers in valid ranges (0-255 for RGB, 0-100 for L)

**Behavior:**
- Converts LED tuples to raw bytes: `[r1, g1, b1, l1, r2, g2, b2, l2, ...]`
- Sends via Unix socket to controller container
- Updates global `leds` state
- Rate-limited: 0.05s delay per call

**Returns:** `True` on success

**Raises:**
- `ValueError`: If list size doesn't match, invalid tuple format, or values out of range
- `TypeError`: If input is not a list or contains non-integers

**Example:**
```python
# Set all LEDs to white at 50% brightness
led_count = getLEDCount()
states = [(255, 255, 255, 50) for _ in range(led_count)]
setLEDs(states)

# Alternating red and blue
states = [RED if i % 2 == 0 else BLUE for i in range(led_count)]
setLEDs(states)

# Custom gradient
states = [(255, i * 10, 0, 100) for i in range(led_count)]
setLEDs(states)
```

---

#### `clearLEDs() -> None`
Turns off all LEDs (sets all to brightness 0).

**Equivalent to:** `setLEDs([(0, 0, 0, 0)] * getLEDCount())`

**Example:**
```python
clearLEDs()  # All LEDs off
```

---

#### `get_exposed_functions() -> dict`
Internal function that collects all public functions to expose to user code.

**Returns:** Dictionary mapping function names to callable objects

**Note:** Not exposed to user code. Used internally by `main.py` to populate the restricted globals.

---

## Protocol Details

### Socket Communication
- **Transport:** Unix domain socket (AF_UNIX, SOCK_STREAM)
- **Payload Format:** Raw bytes, 4 bytes per LED in sequence
  - Byte order: `[R1, G1, B1, L1, R2, G2, B2, L2, ..., Rn, Gn, Bn, Ln]`
  - Total size: `SIZE * 4` bytes

### Rate Limiting
- **Socket messages**: 0.1s delay (`_send_message`)
- **LED updates**: 0.05s delay (`setLEDs`)

### Error Handling
- Socket connection failures return: `"OK (LED server not connected)"`
- Allows graceful degradation when controller is unavailable

---

## Example User Programs

### Simple Solid Color
```python
led_count = getLEDCount()
states = [GREEN] * led_count
setLEDs(states)
print(f"Set {led_count} LEDs to green!")
```

### Rainbow Pattern
```python
import math

led_count = getLEDCount()
states = []

for i in range(led_count):
    hue = (i / led_count) * 360
    # Simple RGB conversion for demonstration
    if hue < 120:
        r, g, b = 255, int(hue * 2.125), 0
    elif hue < 240:
        r, g, b = int((240 - hue) * 2.125), 255, 0
    else:
        r, g, b = 0, int((hue - 240) * 2.125), 255
    
    states.append((r, g, b, 100))

setLEDs(states)
```

### Random Flashing
```python
import random

led_count = getLEDCount()
colors = [RED, GREEN, BLUE, YELLOW, CYAN, MAGENTA]

for _ in range(10):  # Flash 10 times
    states = [random.choice(colors) for _ in range(led_count)]
    setLEDs(states)
```

### Brightness Wave
```python
import math

led_count = getLEDCount()
states = []

for i in range(led_count):
    brightness = int(50 + 50 * math.sin(i * 0.5))
    states.append((255, 100, 0, brightness))

setLEDs(states)
print("Orange wave applied!")
```

---

## Security Notes

**Blocked Operations:**
- File I/O (`open`, file operations)
- Network access (`socket`, `urllib`, `requests`)
- System calls (`os`, `sys`, `subprocess`)
- Dynamic imports (`__import__`, `importlib`)
- Code evaluation (`eval`, `exec`, `compile`)
- Dangerous builtins (`globals()`, `locals()`, `vars()`)

**Timeout:** All user code is subject to a 45-second maximum execution time (enforced by scheduler).

**Resource Limits:** Rate limiting prevents socket/LED spam.
